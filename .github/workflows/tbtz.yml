name: Auto Sync from everett7623/vps_scripts

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è‡ªåŠ¨åŒæ­¥
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # è·å–ç›®æ ‡ä»“åº“çš„é»˜è®¤åˆ†æ”¯
      - name: Detect target default branch
        id: branch_detector
        run: |
          DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${{ secrets.SYNC_TOKEN }}" \
          "https://api.github.com/repos/13ztop/vps_scripts" | jq -r .default_branch)
          echo "Detected default branch: $DEFAULT_BRANCH"
          echo "DEFAULT_BRANCH=$DEFAULT_BRANCH" >> $GITHUB_ENV

      # æ£€å‡ºç›®æ ‡ä»“åº“
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SYNC_TOKEN }}
          repository: 13ztop/vps_scripts
          path: target-repo
          ref: ${{ env.DEFAULT_BRANCH }}
          fetch-depth: 0

      # å…‹éš†æºä»“åº“
      - name: Clone source repo
        run: |
          git clone --depth 1 https://github.com/everett7623/vps_scripts.git source-repo
          echo "æºä»“åº“ everett7623/vps_scripts å…‹éš†å®Œæˆ"

      # åˆ›å»ºå¤‡ä»½ç›®å½•
      - name: Create backup directory
        run: mkdir -p /tmp/repo-backup

      # è¯†åˆ«éœ€è¦ä¿ç•™çš„æ–‡ä»¶ï¼ˆVPSè„šæœ¬é¡¹ç›®ç‰¹å®šæ–‡ä»¶ï¼‰
      - name: Identify protected files
        id: find_protected
        run: |
          # VPSè„šæœ¬é¡¹ç›®éœ€è¦ä¿ç•™çš„æ ¸å¿ƒæ–‡ä»¶åˆ—è¡¨
          protected_files=(
            "README.md"
            "LICENSE"
            ".github/workflows/*"    # å·¥ä½œæµé…ç½®
            "config.ini"             # é…ç½®æ–‡ä»¶
            "credentials.env"        # è®¤è¯æ–‡ä»¶
            "custom_scripts/*"       # è‡ªå®šä¹‰è„šæœ¬ç›®å½•
            "backup/*"               # å¤‡ä»½ç›®å½•
            "secrets/*"              # å¯†é’¥ç›®å½•
            "user_config.sh"         # ç”¨æˆ·é…ç½®
          )
          
          # åˆ›å»ºä¿ç•™æ–‡ä»¶åˆ—è¡¨
          mkdir -p /tmp/repo-backup
          for pattern in "${protected_files[@]}"; do
            find target-repo -path "*/$pattern" -print >> /tmp/repo-backup/protected-files.txt 2>/dev/null || true
          done
          
          # æ·»åŠ ç‰¹æ®Šå¤„ç†
          echo "target-repo/.gitignore" >> /tmp/repo-backup/protected-files.txt
          echo "target-repo/.github/**" >> /tmp/repo-backup/protected-files.txt
          
          # ä¿å­˜æ–‡ä»¶æ•°é‡
          if [ -f /tmp/repo-backup/protected-files.txt ]; then
            protected_count=$(sort -u /tmp/repo-backup/protected-files.txt | wc -l)
            echo "protected_files_count=$protected_count" >> $GITHUB_OUTPUT
          else
            echo "protected_files_count=0" >> $GITHUB_OUTPUT
          fi
          
          echo "ä¿æŠ¤æ–‡ä»¶è¯†åˆ«å®Œæˆ"

      # å¤‡ä»½éœ€è¦ä¿ç•™çš„æ–‡ä»¶
      - name: Backup protected content
        run: |
          mkdir -p /tmp/repo-backup/protected-files
          
          if [ -f /tmp/repo-backup/protected-files.txt ]; then
            while read file; do
              if [ -f "$file" ] || [ -d "$file" ]; then
                relative_path=${file#target-repo/}
                mkdir -p "/tmp/repo-backup/protected-files/$(dirname "$relative_path")"
                cp -r "$file" "/tmp/repo-backup/protected-files/$relative_path"
              fi
            done < <(sort -u /tmp/repo-backup/protected-files.txt)
          fi
          
          echo "ä¿æŠ¤æ–‡ä»¶å¤‡ä»½å®Œæˆ"

      # è·å–æºä»“åº“ç‰ˆæœ¬ä¿¡æ¯
      - name: Get source repository version
        id: source_version
        run: |
          cd source-repo
          echo "commit_hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "full_hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "commit_date=$(git log -1 --format=%cd --date=format:'%Y-%m-%d')" >> $GITHUB_OUTPUT

      # è·å–ç›®æ ‡ä»“åº“ç‰ˆæœ¬ä¿¡æ¯
      - name: Get target repository commit
        id: target_version
        run: |
          cd target-repo
          echo "TARGET_COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "TARGET_BRANCH=${{ env.DEFAULT_BRANCH }}" >> $GITHUB_ENV

      # æ‰§è¡ŒåŒæ­¥æ“ä½œ
      - name: Sync repositories
        run: |
          # ä½¿ç”¨rsyncåŒæ­¥ï¼Œæ’é™¤.gitç›®å½•å’Œå¤‡ä»½æ–‡ä»¶
          rsync -av --delete \
            --exclude=.git \
            --exclude-from=/tmp/repo-backup/protected-files.txt \
            source-repo/ target-repo/
          
          echo "æºä»“åº“å†…å®¹åŒæ­¥å®Œæˆ"

      # æ¢å¤ä¿æŠ¤æ–‡ä»¶
      - name: Restore protected content
        run: |
          if [ -d /tmp/repo-backup/protected-files ]; then
            cd /tmp/repo-backup/protected-files
            find . -type f -o -type d | while read item; do
              if [ -f "$item" ] || [ -d "$item" ]; then
                relative_path=${item#./}
                mkdir -p "$GITHUB_WORKSPACE/target-repo/$(dirname "$relative_path")"
                cp -r "$item" "$GITHUB_WORKSPACE/target-repo/$relative_path"
              fi
            done
          fi
          
          echo "ä¿æŠ¤æ–‡ä»¶æ¢å¤å®Œæˆ"

      # æäº¤å’Œæ¨é€å˜æ›´
      - name: Commit and push changes
        id: commit_push
        run: |
          cd target-repo
          git config user.name "VPS Scripts Sync Bot"
          git config user.email "vps-sync@users.noreply.github.com"
          git add -A
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff-index --quiet HEAD --; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            echo "no_changes_detected=true" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´"
          else
            # è®¡ç®—å˜æ›´æ–‡ä»¶æ•°é‡
            changes_count=$(git diff --name-only HEAD | wc -l)
            echo "changes_count=$changes_count" >> $GITHUB_OUTPUT
            
            # ç”Ÿæˆæäº¤ä¿¡æ¯
            commit_msg="ğŸ”„ è‡ªåŠ¨åŒæ­¥: æ¥è‡ª everett7623/vps_scripts@${{ steps.source_version.outputs.commit_hash }}"
            commit_msg+="\n\næ›´æ–° $changes_count ä¸ªæ–‡ä»¶"
            if [ ${{ steps.find_protected.outputs.protected_files_count }} -gt 0 ]; then
              commit_msg+=", ä¿ç•™ ${{ steps.find_protected.outputs.protected_files_count }} ä¸ªè‡ªå®šä¹‰æ–‡ä»¶"
            fi
            
            git commit -m "$commit_msg"
            # ä½¿ç”¨å¼ºåˆ¶æ¨é€ç¡®ä¿èƒ½æ›´æ–°å—ä¿æŠ¤åˆ†æ”¯
            git push --force-with-lease origin HEAD:${{ env.DEFAULT_BRANCH }}
            
            # è·å–æäº¤åçš„æ–°commit hash
            echo "TARGET_COMMIT_AFTER=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
            echo "TARGET_FULL_HASH_AFTER=$(git rev-parse HEAD)" >> $GITHUB_ENV
            
            echo "commit_msg=$commit_msg" >> $GITHUB_OUTPUT
            echo "å˜æ›´å·²æˆåŠŸæ¨é€"
          fi

      # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      - name: Cleanup
        run: |
          rm -rf source-repo
          rm -rf /tmp/repo-backup

      # è®¾ç½®æ—¶åŒºï¼ˆä¸Šæµ·æ—¶é—´ï¼‰
      - name: Set Shanghai time
        id: set_time
        run: |
          CURRENT_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M %Z')
          CURRENT_TIME_SHORT=$(TZ='Asia/Shanghai' date +'%H:%M %Z')
          echo "CURRENT_TIME=$CURRENT_TIME" >> $GITHUB_ENV
          echo "CURRENT_TIME_SHORT=$CURRENT_TIME_SHORT" >> $GITHUB_ENV

      # åŒæ­¥æˆåŠŸé€šçŸ¥
      - name: Notify Telegram on Sync Success
        if: success() && steps.commit_push.outputs.commit_msg
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ğŸš€ *VPSè„šæœ¬åŒæ­¥æˆåŠŸ | ${{ steps.source_version.outputs.commit_date }} (${{ env.CURRENT_TIME_SHORT }})*
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ”„ **æºä»“åº“**: [everett7623/vps_scripts@${{ steps.source_version.outputs.commit_hash }}](https://github.com/everett7623/vps_scripts/commit/${{ steps.source_version.outputs.full_hash }})
            ğŸ“¦ **ç›®æ ‡ä»“åº“**: [13ztop/vps_scripts@${{ env.TARGET_COMMIT_AFTER }}](https://github.com/13ztop/vps_scripts/commit/${{ env.TARGET_FULL_HASH_AFTER }})
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ“‚ **å˜æ›´æ–‡ä»¶**: ${{ steps.commit_push.outputs.changes_count }} ä¸ª
            ğŸ”’ **ä¿ç•™æ–‡ä»¶**: ${{ steps.find_protected.outputs.protected_files_count }} ä¸ª
            ğŸ•’ **åŒæ­¥æ—¶é—´**: ${{ env.CURRENT_TIME }}
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            âœ… åŒæ­¥å®Œæˆ! ä»“åº“å·²æ›´æ–°
          parse_mode: markdown

      # æ— å˜æ›´é€šçŸ¥
      - name: Notify Telegram on No Changes
        if: success() && steps.commit_push.outputs.no_changes_detected
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            â„¹ï¸ *VPSè„šæœ¬åŒæ­¥æŠ¥å‘Š | ${{ steps.source_version.outputs.commit_date }} (${{ env.CURRENT_TIME_SHORT }})*
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ”„ **æºä»“åº“**: [everett7623/vps_scripts@${{ steps.source_version.outputs.commit_hash }}](https://github.com/everett7623/vps_scripts)
            ğŸ“¦ **ç›®æ ‡ä»“åº“**: [13ztop/vps_scripts@${{ env.TARGET_COMMIT }}](https://github.com/13ztop/vps_scripts)
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ”’ **ä¿ç•™æ–‡ä»¶**: ${{ steps.find_protected.outputs.protected_files_count }} ä¸ª
            ğŸ†— **åŒæ­¥çŠ¶æ€**: å†…å®¹ä¸€è‡´ï¼Œæ— éœ€æ›´æ–°
            ğŸ•’ **æ£€æµ‹æ—¶é—´**: ${{ env.CURRENT_TIME }}
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            âœ… ä»“åº“å·²æ˜¯æœ€æ–°çŠ¶æ€
          parse_mode: markdown

      # åŒæ­¥å¤±è´¥é€šçŸ¥
      - name: Notify Telegram on Failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            â€¼ï¸ *VPSè„šæœ¬åŒæ­¥å¤±è´¥ | ${{ env.CURRENT_TIME_SHORT }}*
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            âš™ï¸ **å·¥ä½œæµ**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            ğŸ•’ **å‘ç”Ÿæ—¶é—´**: ${{ env.CURRENT_TIME }}
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            âŒ é”™è¯¯è¯¦æƒ…: è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—
            [æŸ¥çœ‹é”™è¯¯è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          parse_mode: markdown
